<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSフィールドマップ</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
}

.screen {
  display: none;
  padding: 20px;
}

.active {
  display: block;
}

button {
  font-size: 18px;
  padding: 10px 20px;
  margin: 8px;
}

canvas {
  background: #222;
  margin-top: 10px;
  border: 1px solid #555;
}

#timerDisplay {
  font-size: 40px;
  font-weight: bold;
  color: white;
}
</style>
</head>

<body>

<!-- ===== メイン画面 ===== -->
<div id="mainScreen" class="screen active">
  <h1>FIELD MAP</h1>
  <button onclick="startGame()">フィールド開始</button>
</div>

<!-- ===== フィールド画面 ===== -->
<div id="fieldScreen" class="screen">
  <div id="timerDisplay">0:00.00</div>

  <canvas id="map" width="300" height="300"></canvas>

  <div>
    <button onclick="toggleTimer()">スタート / ストップ</button>
    <button onclick="openSettings()">設定</button>
  </div>
</div>

<!-- ===== 設定画面 ===== -->
<div id="settingsScreen" class="screen">
  <h2>設定</h2>
  <button onclick="backToMain()">メイン画面に戻る</button><br>
  <button onclick="openTimerSetting()">タイマーセット</button>
</div>

<!-- ===== タイマー設定画面 ===== -->
<div id="timerSettingScreen" class="screen">
  <h2>タイマー設定</h2>
  <input type="number" id="gameMinutes" min="1" value="10"> 分<br><br>
  <button onclick="saveTimer()">保存</button>
</div>

<script>
/* ===== 画面管理 ===== */
const mainScreen = document.getElementById("mainScreen");
const fieldScreen = document.getElementById("fieldScreen");
const settingsScreen = document.getElementById("settingsScreen");
const timerSettingScreen = document.getElementById("timerSettingScreen");
const timerDisplay = document.getElementById("timerDisplay");

function showScreen(screen) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  screen.classList.add("active");
}

/* ===== タイマー ===== */
let gameTimeMs = 10 * 60 * 1000;
let remainingMs = 0;
let timerRunning = false;
let timerInterval = null;

function updateTimerDisplay() {
  let displayMs = remainingMs;

  // 3分より多い時は 4:00 固定表示
  if (remainingMs > 3 * 60 * 1000) {
    timerDisplay.textContent = "4:00.00";
    timerDisplay.style.color = "white";
    timerDisplay.style.textShadow = "none";
    return;
  }

  if (displayMs < 0) displayMs = 0;

  const min = Math.floor(displayMs / 60000);
  const sec = Math.floor((displayMs % 60000) / 1000);
  const cs  = Math.floor((displayMs % 1000) / 10); // 1/100秒

  timerDisplay.textContent =
    `${min}:${String(sec).padStart(2, "0")}.${String(cs).padStart(2, "0")}`;

  // 残り3分以下で赤
  if (remainingMs <= 3 * 60 * 1000) {
    timerDisplay.style.color = "red";
    timerDisplay.style.textShadow = "0 0 8px red";
  } else {
    timerDisplay.style.color = "white";
    timerDisplay.style.textShadow = "none";
  }
}

function toggleTimer() {
  timerRunning ? stopTimer() : startTimer();
}

function startTimer() {
  if (timerRunning) return;
  timerRunning = true;

  timerInterval = setInterval(() => {
    remainingMs -= 10;
    if (remainingMs <= 0) {
      remainingMs = 0;
      stopTimer();
    }
    updateTimerDisplay();
  }, 10);
}

function stopTimer() {
  timerRunning = false;
  clearInterval(timerInterval);
}

/* ===== 画面遷移 ===== */
function startGame() {
  remainingMs = gameTimeMs;
  updateTimerDisplay();
  showScreen(fieldScreen);
  drawMap();
}

function openSettings() {
  stopTimer();
  showScreen(settingsScreen);
}

function backToMain() {
  stopTimer();
  showScreen(mainScreen);
}

function openTimerSetting() {
  document.getElementById("gameMinutes").value = gameTimeMs / 60000;
  showScreen(timerSettingScreen);
}

function saveTimer() {
  const min = Number(document.getElementById("gameMinutes").value);
  gameTimeMs = min * 60000;
  remainingMs = gameTimeMs;
  updateTimerDisplay();
  showScreen(fieldScreen);
}

/* ===== マップ描画 ===== */
function drawMap() {
  const canvas = document.getElementById("map");
  const ctx = canvas.getContext("2d");

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#444";
  for (let i = 0; i <= 10; i++) {
    ctx.beginPath();
    ctx.moveTo(i * 30, 0);
    ctx.lineTo(i * 30, 300);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0, i * 30);
    ctx.lineTo(300, i * 30);
    ctx.stroke();
  }

  ctx.fillStyle = "lime";
  ctx.beginPath();
  ctx.arc(150, 150, 6, 0, Math.PI * 2);
  ctx.fill();
}
</script>

</body>
</html>