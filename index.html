<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">

<!-- スマホ向け表示設定 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<title>Field Timer</title>

<style>
/* ==================================================
   全体共通設定
================================================== */
body {
  margin: 0;
  background: #111;
  color: #eee;
  text-align: center;
  /* フォント固定（斜線入り0が使える） */
  font-family: "JetBrains Mono", "Source Code Pro", monospace;
}

/* 画面切り替え用 */
.screen {
  display: none;
  padding: 10px;
}
.active {
  display: block;
}

/* ==================================================
   メイン画面
================================================== */
.version {
  font-size: 14px;
  color: #aaa;
}

/* ==================================================
   タイマー表示
================================================== */
#timer {
  font-size: 48px;
  margin: 15px auto;
  width: 280px; /* 数字ズレ防止 */
  font-variant-numeric: slashed-zero; /* 斜線入り0 */
}

/* 3分以下で赤 */
.red {
  color: #ff4444;
}

/* 30秒以下で点滅 */
.blink {
  animation: blink 0.4s steps(1) infinite;
}

/* 点滅アニメーション定義 */
@keyframes blink {
  50% { opacity: 0; }
}
   
/* 0秒専用：フェード点滅 */
@keyframes fadeBlink {
  0%   { opacity: 1; }
  60%  { opacity: 0; }
  100% { opacity: 1; }
}

.zero-blink {
  animation: fadeBlink 1.2s infinite;
}

/* ==================================================
   擬似マップ
================================================== */
#map {
  width: 300px;
  height: 300px;
  margin: 10px auto;
  background: #222;
  border: 2px solid #555;
  position: relative;
}

/* グリッド表示 */
.grid {
  position: absolute;
  width: 100%;
  height: 100%;
  background-size: 30px 30px;
  background-image:
    linear-gradient(to right, #333 1px, transparent 1px),
    linear-gradient(to bottom, #333 1px, transparent 1px);
}

/* 自分の位置（仮表示） */
.player {
  width: 10px;
  height: 10px;
  background: #4af;
  border-radius: 50%;
  position: absolute;
  top: 145px;
  left: 145px;
}

/* ==================================================
   GPS表示
================================================== */
#gps {
  font-size: 14px;
  margin-top: 8px;
  color: #8cf;
  line-height: 1.4;
}

/* ==================================================
   ボタン共通
================================================== */
button {
  font-size: 16px;
  padding: 8px 14px;
  margin: 5px;
}
</style>
</head>

<body>

<!-- ==================================================
     メイン画面
================================================== -->
<div id="main" class="screen active">
  <h1>Field Map</h1>
  <div class="version">Version 0.9</div>
  <button onclick="openField()">START</button>
</div>

<!-- ==================================================
     フィールド画面
================================================== -->
<div id="field" class="screen">

  <!-- タイマー表示 -->
  <div id="timer">00:00</div>

  <!-- 擬似マップ -->
  <div id="map">
    <div class="grid"></div>
    <div class="player"></div>
  </div>

  <!-- GPS情報表示 -->
  <div id="gps">GPS: 未取得</div>

  <!-- 操作ボタン -->
  <button onclick="toggleStart()">START / STOP</button>
  <button onclick="resetTimer()">RESET</button>
  <button onclick="scan()">SCAN</button>
  <button onclick="openSettings()">SETTINGS</button>
</div>

<!-- ==================================================
     設定画面
================================================== -->
<div id="settings" class="screen">
  <h2>Settings</h2>
  <button onclick="openTimerSet()">タイマーセット</button><br>
  <button onclick="backToMain()">メイン画面に戻る</button>
</div>

<!-- ==================================================
     タイマー設定画面
================================================== -->
<div id="timerSet" class="screen">
  <h2>Timer Set (min)</h2>
  <!-- 初期値は0分 -->
  <input id="minuteInput" type="number" min="0" value="0">
  <br><br>
  <button onclick="setTimer()">決定</button>
  <button onclick="openSettings()">戻る</button>
</div>

<script>
/* ==================================================
   タイマー関連変数
================================================== */

// 設定されたゲーム時間（ms）
let setTimeMs = 0;

// 現在の残り時間（ms）
let remainingMs = 0;

// タイマーが動作中かどうか
let running = false;

// setInterval管理用
let timerInterval = null;

// 実時間計測用（ズレ防止）
let startTimestamp = 0;
let lastRemainingMs = 0;
   
// タイマー0専用状態
let zeroMode = false;
   
/* ==================================================
   画面切り替え制御
================================================== */
function show(id) {
  document.querySelectorAll('.screen')
    .forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function openField()   { show('field'); updateDisplay(); }
function openSettings(){ show('settings'); }
function backToMain()  { show('main'); }
function openTimerSet(){ show('timerSet'); }

/* ==================================================
   タイマー設定処理
================================================== */
function setTimer() {
  const min = Number(document.getElementById('minuteInput').value);

  // 分 → ミリ秒に変換
  setTimeMs = min * 60 * 1000;
  remainingMs = setTimeMs;

  updateDisplay(remainingMs);
  show('field');
}

/* ==================================================
   タイマー開始 / 停止
================================================== */
function toggleStart() {
  if (!running) {
    // 残り0なら設定時間から開始
    if (remainingMs <= 0) remainingMs = setTimeMs;

    running = true;
    startTimestamp = performance.now();
    lastRemainingMs = remainingMs;

    // 実時間差分方式（Safari対策）
    timerInterval = setInterval(() => {
      const now = performance.now();
      const elapsed = now - startTimestamp;

      remainingMs = Math.max(0, lastRemainingMs - elapsed);

      if (remainingMs === 0) stopTimer();
      updateDisplay();
    }, 50);

  } else {
    stopTimer();
  }
}

/* タイマー停止 */
function stopTimer() {
  running = false;
  clearInterval(timerInterval);
}
/* タイマー０モード */
if (remainMs <= 0) {
  remainMs = 0;
  running = false;
  zeroMode = true;   // ← 0モード突入
}

/* リセット（設定時間に戻す） */
function resetTimer() {
  running = false;
  zeroMode = false;        // ← これが肝
  remainMs = setMs;        // 設定時間に戻す
  updateDisplay(remainMs);
}


/* ==================================================
   GPSスキャン（現在位置取得）
================================================== */
function scan() {
  const gps = document.getElementById("gps");

  if (!navigator.geolocation) {
    gps.textContent = "GPS: 非対応端末";
    return;
  }

  gps.textContent = "GPS: 取得中…";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const acc = Math.round(pos.coords.accuracy);

      gps.textContent = `Lat:${lat},Lon:${lon}`;
     
    },
    () => {
      gps.textContent = "GPS: 取得失敗";
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

/* ==================================================
   タイマー表示更新
================================================== */
function updateDisplay(ms) {
  const t = document.getElementById("timer");

  // クラスと色を毎回リセット（ガクつき防止）
  t.classList.remove("red", "blink", "zero-blink");
  t.style.color = "#fff";

  // ===== 起動直後（0で点滅なし）=====
  if (!running && !zeroMode && ms === 0) {
    t.textContent = "00:00";
    return;
  }

  // ===== タイマー0専用表示（リセットまで続く）=====
  if (zeroMode) {
    t.style.color = "red";
    t.classList.add("zero-blink");
    t.textContent = "00:00:00";
    return;
  }

  // ===== 通常カウント中 =====
  if (ms <= 180000) t.classList.add("red");     // 3分以下で赤
  if (ms <= 30000)  t.classList.add("blink");   // 30秒以下で点滅

  // 表示フォーマット
  if (ms > 180000) {
    t.textContent = formatMMSS(ms);       // 例 04:00
  } else {
    t.textContent = formatMMSSCC(ms);     // 例 03:00:00
  }
}


// 初期表示
updateDisplay();
</script>

</body>
</html>
