<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Field Timer</title>

<style>
/* ========================================  ↓↓↓CSS ===================================================================== */
/* ==================================================
   全体共通設定
================================================== */
body {
  margin: 0;
  background: #111;
  color: #eee;
  text-align: center;
  /* フォント固定（斜線入り0が使える） */
  font-family: "JetBrains Mono", "Source Code Pro", monospace;
}

.screen { display: none; padding: 10px; }
.active { display: block; }

.version { font-size: 14px; color: #aaa; }

/* ==================================================
   タイマー表示
================================================== */
#timer {
  font-size: 30px;
  margin: -5px auto 1px;
  width: 280px; /* 数字ズレ防止 */
  font-variant-numeric: slashed-zero; /* 斜線入り0 */
}

/* 3分以下：red orange */
.red { color: #FF4500; }

/* 30秒以下：点滅（red orange） */
.blink {
  animation: blink 0.4s steps(1) infinite;
  color: #FF4500;
}
@keyframes blink { 50% { opacity: 0; } }

/* 0秒：赤フェード点滅（リセットまで） */
.zero-blink {
  animation: fadeBlink 1.2s infinite;
  color: #ff3333;
}
@keyframes fadeBlink {
  0%   { opacity: 1; }
  60%  { opacity: 0; }
  100% { opacity: 1; }
}

/* ==================================================
   マップ表示
================================================== */
#map {
  width: min(96vw,420px);
  height: min(96vw,420px);
  margin: 8px auto 8px;
  background: #222;
  border: 2px solid #555;
  position: relative;
  overflow: hidden;
}

/* グリッド */
.grid {
  position: absolute;
  inset: 0;
  background-size: 30px 30px;
  background-image:
    linear-gradient(to right, rgba(0,220,255,0.75) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(0,220,255,0.75) 1px, transparent 1px);
  pointer-events: none;
  z-index: 3;                /* マップより前に表示 */
}
/* グリッドラベル */
#gridLabels {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 3; /* グリッドと同じ最前面 */
  
  /*シアン文字*/
  font-size: 11px;
  color: rgba(120,245,255,0.95);
  font-weight: 600;
  font-variant-numeric: tabular-nums;
  
  /*地図に負けないやつ*/
  text-shadow: 0 0 3px rgba(0,0,0,0.9), 0 0 6px rgda(0,0,0,0.6);
  
}
.grid-x ,.drid-y{
  position: absolute;
  background: rgba(0,0,0,0.45);
  padding: 1px 4px;
  border-radius: 4px;
}


.grid-x {
  top: 2px;
  transform: translateX(-50%);
}

.grid-y {
  left: 4px;
  transform: translateY(-50%);
}

/* マップ画像（中央配置＋スケール） */
#mapImg {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(var(--imgScale, 1));
  transform-origin: center center;
  max-width: none;
  max-height: none;
  user-select: none;
  -webkit-user-drag: none;
  pointer-events: none;
  opacity: 0.9;
  z-index: 1;   /*グリッドより下に表示*/
}

/* 自分の位置ドット */
#meDot{
  position:absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background:#00e5ff;
  border:2px solid rgba(255,255,255,0.85);
  box-shadow: 0 0 0 2px rgba(0,0,0,0.35);
  transform: translate(-50%, -50%);
  pointer-events:none;
  z-index: 5;      /* 最前面に表示 */
  display:none;
  
}

/* ==================================================
   GPS表示（固定幅でガタつき防止）
================================================== */
#gps {
  font-size: 14px;
  margin: 8px auto 0;
  color: #8cf;

  width: 260px;
  height: 20px;
  line-height: 20px;

  display: flex;
  align-items: center;
  justify-content: center;

  white-space: nowrap;
  overflow: hidden;

  font-variant-numeric: tabular-nums;
}

/* ==================================================
   フィールド一覧（メイン画面）
================================================== */
#fieldList {
  width: min(92vw, 420px);
  margin: 12px auto 0;
  text-align: left;
  background: #161616;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 10px 12px;
}

.fieldItem {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  padding: 10px 8px;
  border-bottom: 1px dashed #2a2a2a;
}
.fieldItem:last-child { border-bottom: none; }

.fieldName { font-size: 14px; color: #e8e8e8; }
.fieldId   { font-size: 12px; color: #888; }

/* ==================================================
   ボタン共通
================================================== */
button {
  font-size: 16px;
  padding: 8px 14px;
  margin: 5px;
}
</style>
</head>

<body>
<!-- ========================================= ↓↓↓HTML ================================================================-->
<!-- ==================================================
     メイン画面（フィールド選択）
================================================== -->
<div id="main" class="screen active">
  <h1>Field Timer</h1>
  <div class="version">Version 2.1.6</div> <!--==============ヴァージョン=============-->
  <div id="fieldList">読み込み中…</div>
</div>

<!-- ==================================================
     フィールド画面（タイマー＋マップ）
================================================== -->
<div id="field" class="screen">
  <h2 id="fieldTitle">Field</h2>

  <div id="timer">00:00</div>

  <div id="map">
    <div class="grid"></div> 
    <div id="gridLabels"></div> <!-- グリッドラベル-->
    <img id="mapImg" alt="map">
    <div id="meDot"></div>
  </div>

  <div id="gps">--.------:--.------</div>

  <button type="button" onclick="toggleStart()">START / STOP</button>
  <button type="button" onclick="resetTimer()">RESET</button>
  <button type="button" onclick="scan()">SCAN</button>
  <button type="button" onclick="openSettings()">SETTINGS</button>
</div>

<!-- ==================================================
     設定画面
================================================== -->
<div id="settings" class="screen">
  <h2>Settings</h2>
  <button type="button" onclick="openTimerSet()">タイマーセット</button><br>
  <button type="button" onclick="backToMain()">メイン画面に戻る</button>
</div>

<!-- ==================================================
     タイマー設定画面
================================================== -->
<div id="timerSet" class="screen">
  <h2>Timer Set (min)</h2>
  <input id="minuteInput" type="number" min="0" value="0">
  <br><br>
  <button type="button" onclick="setTimer()">決定</button>
  <button type="button" onclick="openSettings()">戻る</button>
</div>

<script>
/* ====================================   ↓↓↓JS ========================================================================== */
/* ==================================================
  画面切り替え
================================================== */
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function backToMain()   { show('main'); }
function openSettings() { show('settings'); }
function openTimerSet() { show('timerSet'); }

/* ==================================================
  タイマー関連（実時間差分方式）
================================================== */
let setTimeMs = 0;        // 設定された時間
let remainingMs = 0;      // 残り
let running = false;      // 動作中
let zeroMode = false;     // 0秒フェード点滅状態

let timerInterval = null;
let startTimestamp = 0;
let lastRemainingMs = 0;

function setTimer() {
  document.activeElement.blur(); // iOSキーボード対策
  const min = Number(document.getElementById('minuteInput').value);

  setTimeMs = min * 60 * 1000;
  remainingMs = setTimeMs;

  zeroMode = false;
  updateDisplay(remainingMs);
  show('field');
}

function toggleStart() {
  if (!running) {
    if (remainingMs <= 0) remainingMs = setTimeMs;

    running = true;
    startTimestamp = performance.now();
    lastRemainingMs = remainingMs;

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - startTimestamp;
      remainingMs = Math.max(0, lastRemainingMs - elapsed);

      if (remainingMs === 0) {
        stopTimer();
        zeroMode = true; // 0秒フェード点滅へ
      }
      updateDisplay(remainingMs);
    }, 50);

  } else {
    stopTimer();
  }
}

function stopTimer() {
  running = false;
  clearInterval(timerInterval);
}

function resetTimer() {
  stopTimer();
  zeroMode = false;
  remainingMs = setTimeMs;
  updateDisplay(remainingMs);
}

function updateDisplay(ms) {
  const t = document.getElementById("timer");
  t.classList.remove("red", "blink", "zero-blink");

  // 起動直後（0で点滅なし）
  if (!running && !zeroMode && ms === 0) {
    t.textContent = "00:00";
    return;
  }

  // 0秒モード（リセットまで継続）
  if (zeroMode) {
    t.classList.add("zero-blink");
    t.textContent = "00:00:00";
    return;
  }

  // 3分以下で赤orange、30秒以下で点滅
  if (ms <= 180000) t.classList.add("red");
  if (ms <= 30000)  t.classList.add("blink");

  const m  = Math.floor(ms / 60000);
  const s  = Math.floor((ms % 60000) / 1000);
  const cs = Math.floor((ms % 1000) / 10);

  t.textContent = (ms > 180000)
    ? `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
    : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(cs).padStart(2,'0')}`;
}

/* ==================================================
  フィールドJSON読み込み
================================================== */
let currentField = null;
let H = null;        // ホモグラフィ係数
let lat0 = 0, lon0 = 0, cosLat0 = 1;

const mapImg = document.getElementById("mapImg");
const meDot  = document.getElementById("meDot");
const gpsEl  = document.getElementById("gps");

async function loadFieldList() {
  const box = document.getElementById("fieldList");
  try {
    const res = await fetch("fields/fields.json", { cache: "no-store" });
    if (!res.ok) throw new Error("fields.json not found");
    const list = await res.json();

    if (!Array.isArray(list) || list.length === 0) {
      box.textContent = "fields/fields.json が空です";
      return;
    }

    box.innerHTML = "";
    list.forEach(item => {
      const row = document.createElement("div");
      row.className = "fieldItem";

      const left = document.createElement("div");
      left.innerHTML =
        `<div class="fieldName">${escapeHtml(item.name || item.id)}</div>
         <div class="fieldId">${escapeHtml(item.id || "")}</div>`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "選択";
      btn.onclick = () => openFieldByFile(item.file);

      row.appendChild(left);
      row.appendChild(btn);
      box.appendChild(row);
    });

  } catch (e) {
    box.textContent = "フィールド一覧の読み込み失敗（fields/fields.json を確認）";
    console.error(e);
  }
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function openFieldByFile(file) {
  try {
    const res = await fetch(`fields/${file}`, { cache: "no-store" });
    if (!res.ok) throw new Error("field json not found");
    const data = await res.json();

    if (!data || !Array.isArray(data.anchors) || data.anchors.length !== 4) {
      alert("フィールドデータが不正（anchorsが4点必要）");
      return;
    }

    currentField = data;
    document.getElementById("fieldTitle").textContent = data.name || data.id || "Field";

    // フィールド読み込み時：タイマーは0初期（必要なら変更OK）
    setTimeMs = 0;
    remainingMs = 0;
    running = false;
    zeroMode = false;
    updateDisplay(0);

    // 画像セット
    document.documentElement.style.setProperty("--imgScale", String(data.defaultImgScale ?? 1.0));
    mapImg.src = data.image;

    // GPS表示初期化（固定幅）
    gpsEl.textContent = "--.------:--.------";

    // 現在地ドット非表示
    meDot.style.display = "none";

    // 4点変換準備
    prepareTransform(data.anchors);

    show("field");

  } catch (e) {
    alert("フィールド読み込み失敗。fieldsフォルダとjsonを確認して。");
    console.error(e);
  }
}

/* ==================================================
  4点GPS → マップXY（ホモグラフィ）
================================================== */
const R = 6378137;

function latLonToLocalMeters(lat, lon) {
  const x = (lon - lon0) * Math.PI/180 * cosLat0 * R;
  const y = (lat - lat0) * Math.PI/180 * R;
  return { X: x, Y: y };
}

function solveLinear(A, b) {
  const n = b.length;
  const M = A.map((row, i) => row.concat([b[i]]));

  for (let col = 0; col < n; col++) {
    let pivot = col;
    for (let r = col + 1; r < n; r++) {
      if (Math.abs(M[r][col]) > Math.abs(M[pivot][col])) pivot = r;
    }
    [M[col], M[pivot]] = [M[pivot], M[col]];

    const div = M[col][col];
    if (Math.abs(div) < 1e-12) throw new Error("singular");

    for (let c = col; c <= n; c++) M[col][c] /= div;

    for (let r = 0; r < n; r++) {
      if (r === col) continue;
      const f = M[r][col];
      for (let c = col; c <= n; c++) M[r][c] -= f * M[col][c];
    }
  }
  return M.map(row => row[n]);
}

function computeHomography(anchors) {
  const A = [];
  const b = [];

  for (const p of anchors) {
    const { X, Y } = latLonToLocalMeters(p.lat, p.lon);
    const x = p.x, y = p.y;

    // x式
    A.push([X, Y, 1, 0, 0, 0, -x*X, -x*Y]); b.push(x);
    // y式
    A.push([0, 0, 0, X, Y, 1, -y*X, -y*Y]); b.push(y);
  }
  return solveLinear(A, b); // [h11..h32], h33=1
}

function prepareTransform(anchors) {
  lat0 = anchors.reduce((s,a)=>s+a.lat,0)/4;
  lon0 = anchors.reduce((s,a)=>s+a.lon,0)/4;
  cosLat0 = Math.cos(lat0 * Math.PI/180);
  H = computeHomography(anchors);
}

function gpsToMapXY(lat, lon) {
  const { X, Y } = latLonToLocalMeters(lat, lon);
  const [h11,h12,h13,h21,h22,h23,h31,h32] = H;

  const denom = h31*X + h32*Y + 1;
  const x = (h11*X + h12*Y + h13) / denom;
  const y = (h21*X + h22*Y + h23) / denom;
  return { x, y };
}
/* ==================================================
      グリッドラベル表示　1,2,3,.... A,B,C,...
=====================================================*/
function buildGridLabels(step = 30) {
  const box = document.getElementById("gridLabels");
  if (!box) return;
  box.innerHTML = "";

  const map = document.getElementById("map");
  const w = map.clientWidth;
  const h = map.clientHeight;

  // 横：A,B,C...
  const cols = Math.floor(w / step);
  for (let i = 0; i <= cols; i++) {
    const d = document.createElement("div");
    d.className = "grid-x";
    d.style.left = `${i * step}px`;
    d.textContent = (i < 26)
      ? String.fromCharCode(65 + i)   // A..Z
      : `A${i - 25}`;                 // 26以降は A1, A2...（保険）
    box.appendChild(d);
  }

  // 縦：1,2,3...
  const rows = Math.floor(h / step);
  for (let i = 0; i <= rows; i++) {
    const d = document.createElement("div");
    d.className = "grid-y";
    d.style.top = `${i * step}px`;
    d.textContent = i + 1;
    box.appendChild(d);
  }
}
/* ==================================================
  GPS SCAN
  ※ getCurrentPosition は非同期。タイマーは止めないが、
     端末負荷で一瞬カクつくことはあり得る（Safariあるある）
================================================== */
function scan() {
  if (!currentField || !H) {
    gpsEl.textContent = "先にフィールド選択";
    return;
  }
  if (!navigator.geolocation) {
    gpsEl.textContent = "GPS: 非対応端末";
    return;
  }

  gpsEl.textContent = "取得中...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // 表示（固定桁でガタつき防止）
      gpsEl.textContent = `${lat.toFixed(6)}:${lon.toFixed(6)}`;

      // マップXYへ変換してドット表示
      const { x, y } = gpsToMapXY(lat, lon);
      meDot.style.left = `${x}px`;
      meDot.style.top  = `${y}px`;
      meDot.style.display = "block";
    },
    () => {
      gpsEl.textContent = "GPS: 取得失敗";
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

/* ==================================================
  起動
================================================== */
updateDisplay(0);
loadFieldList();
buildGridLabels(30);
</script>

</body>
</html>
