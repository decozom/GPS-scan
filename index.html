<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Field Timer</title>

<style>
/* ==================================================
   全体共通設定
================================================== */
body {
  margin: 0;
  background: #111;
  color: #eee;
  text-align: center;
  font-family: "JetBrains Mono", "Source Code Pro", monospace;
}

.screen {
  display: none;
  padding: 10px;
}
.active {
  display: block;
}

/* ==================================================
   メイン画面
================================================== */
.version {
  font-size: 14px;
  color: #aaa;
}

/* ==================================================
   タイマー表示
================================================== */
#timer {
  font-size: 48px;
  margin: 15px auto;
  width: 280px;
  font-variant-numeric: slashed-zero;
}

/*red orange*/
.red {
  color: #FF4500; 
}

/* 30秒以下 点滅 */
.blink {
  animation: blink 0.4s steps(1) infinite;
  color: #FF4500;
}
@keyframes blink {
  50% { opacity: 0; }
}

/* 0秒専用 フェード点滅 */
.zero-blink {
  animation: fadeBlink 1.2s infinite;
  color: #FF4500;  /*red orange*/
}
@keyframes fadeBlink {
  0%   { opacity: 1; }
  60%  { opacity: 0; }
  100% { opacity: 1; }
}

/* ==================================================
   擬似マップ
================================================== */
#map {
  width: 300px;
  height: 300px;
  margin: 10px auto;
  background: #222;
  border: 2px solid #555;
  position: relative;
}

.grid {
  position: absolute;
  width: 100%;
  height: 100%;
  background-size: 30px 30px;
  background-image:
    linear-gradient(to right, #333 1px, transparent 1px),
    linear-gradient(to bottom, #333 1px, transparent 1px);
}

.player {
  width: 10px;
  height: 10px;
  background: #4af;
  border-radius: 50%;
  position: absolute;
  top: 145px;
  left: 145px;
}

/* ==================================================
   GPS表示
================================================== */
#gps {
  font-size: 14px;
  margin-top: 8px;
  color: #8cf;
   
  width: 260px;
  height: 20px;
  line-height: 20px;
  margin-left: auto;
  margin-right: auto;

  display: flex;
  align-items: center;
  justify-content:center;

  white-space: nowrap;
  overflow: hidden;

  font-variant-numeric: tabular-nums;
}

/* ==================================================
   ボタン
================================================== */
button {
  font-size: 16px;
  padding: 8px 14px;
  margin: 5px;
}
</style>
</head>

<body>

<!-- ================= メイン画面 ================= -->
<div id="main" class="screen active">
  <h1>Field Map</h1>
  <div class="version">Version 1.2.7</div> <!-- ========ヴァージョン(毎回更新)=========-->
  <button onclick="openField()">START</button>
</div>

<!-- ================= フィールド画面 ================= -->
<div id="field" class="screen">
  <div id="timer">00:00</div>

  <div id="map">
    <div class="grid"></div>
    <div class="player"></div>
  </div>

  <div id="gps">--.------:--.------</div>

  <button onclick="toggleStart()">START / STOP</button>
  <button onclick="resetTimer()">RESET</button>
  <button onclick="scan()">SCAN</button>
  <button onclick="openSettings()">SETTINGS</button>
</div>

<!-- ================= 設定画面 ================= -->
<div id="settings" class="screen">
  <h2>Settings</h2>
  <button onclick="openTimerSet()">タイマーセット</button><br>
  <button onclick="backToMain()">メイン画面に戻る</button>
</div>

<!-- ================= タイマー設定画面 ================= -->
<div id="timerSet" class="screen">
  <h2>Timer Set (min)</h2>
  <input id="minuteInput" type="number" min="0" value="0">
  <br><br>
  <button type="button" onclick="setTimer()">決定</button>
  <button type="button" onclick="openSettings()">戻る</button>
</div>

<script>
/* ==================================================
   タイマー関連変数
================================================== */
let setTimeMs = 0;
let remainingMs = 0;
let running = false;
let zeroMode = false;

let timerInterval = null;
let startTimestamp = 0;
let lastRemainingMs = 0;

/* ==================================================
   画面切り替え
================================================== */
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function openField()   { show('field'); updateDisplay(remainingMs); }
function openSettings(){ show('settings'); }
function backToMain()  { show('main'); }
function openTimerSet(){ show('timerSet'); }

/* ==================================================
   タイマー設定
================================================== */
function setTimer() {
  document.activeElement.blur(); // キーボード対策
  const min = Number(document.getElementById('minuteInput').value);
  setTimeMs = min * 60 * 1000;
  remainingMs = setTimeMs;
  zeroMode = false;
  updateDisplay(remainingMs);
  show('field');
}

/* ==================================================
   タイマー制御
================================================== */
function toggleStart() {
  if (!running) {
    if (remainingMs <= 0) remainingMs = setTimeMs;

    running = true;
    startTimestamp = performance.now();
    lastRemainingMs = remainingMs;

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - startTimestamp;
      remainingMs = Math.max(0, lastRemainingMs - elapsed);

      if (remainingMs === 0) {
        stopTimer();
        zeroMode = true;
      }
      updateDisplay(remainingMs);
    }, 50);
  } else {
    stopTimer();
  }
}

function stopTimer() {
  running = false;
  clearInterval(timerInterval);
}

function resetTimer() {
  stopTimer();
  zeroMode = false;
  remainingMs = setTimeMs;
  updateDisplay(remainingMs);
}

/* ==================================================
   GPSスキャン
================================================== */
function scan() {
  const gps = document.getElementById("gps");
  if (!navigator.geolocation) {
    gps.textContent = "GPS: 非対応端末";
    return;
  }
  gps.textContent = "GPS: 取得中…";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      gps.textContent = `${lat}:${lon}`;
    },
    () => gps.textContent = "GPS: 取得失敗",
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

/* ==================================================
   タイマー表示更新
================================================== */
function updateDisplay(ms) {
  const t = document.getElementById("timer");
  t.classList.remove("red", "blink", "zero-blink");
  
  // 起動直後
  if (!running && !zeroMode && ms === 0) {
    t.textContent = "00:00";
    return;
  }

  // 0秒モード
  if (zeroMode) {
    t.classList.add("zero-blink");
    t.textContent = "00:00:00";
    return;
  }

  if (ms <= 180000) t.classList.add("red");
  if (ms <= 30000)  t.classList.add("blink");

  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  const cs = Math.floor((ms % 1000) / 10);

  t.textContent = ms > 180000
    ? `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
    : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(cs).padStart(2,'0')}`;
}

updateDisplay(0);
</script>

</body>
</html>
