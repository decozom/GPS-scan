<script>
/* ===== 画面管理 ===== */
const mainScreen = document.getElementById("mainScreen");
const fieldScreen = document.getElementById("fieldScreen");
const settingsScreen = document.getElementById("settingsScreen");
const timerSettingScreen = document.getElementById("timerSettingScreen");
const timerDisplay = document.getElementById("timerDisplay");

function showScreen(screen) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  screen.classList.add("active");
}

/* ===== タイマー ===== */
let gameTimeMs = 10 * 60 * 1000;
let remainingMs = 0;

let timerRunning = false;
let startTimestamp = 0;
let rafId = null;

/* ---- 表示更新 ---- */
function updateTimerDisplay() {
  if (remainingMs <= 0) {
    timerDisplay.textContent = "00:00";
    timerDisplay.style.color = "white";
    timerDisplay.style.textShadow = "none";
    return;
  }

  const min = Math.floor(remainingMs / 60000);
  const sec = Math.floor((remainingMs % 60000) / 1000);

  if (remainingMs > 3 * 60 * 1000) {
    timerDisplay.textContent =
      `${String(min).padStart(2, "0")}:${String(sec).padStart(2, "0")}`;
    timerDisplay.style.color = "white";
    timerDisplay.style.textShadow = "none";
    return;
  }

  const cs = Math.floor((remainingMs % 1000) / 10);
  timerDisplay.textContent =
    `${String(min).padStart(2, "0")}:` +
    `${String(sec).padStart(2, "0")}:` +
    `${String(cs).padStart(2, "0")}`;

  timerDisplay.style.color = "red";
  timerDisplay.style.textShadow = "0 0 8px red";
}

/* ---- 実時間ベースカウント ---- */
function tick() {
  if (!timerRunning) return;

  const now = Date.now();
  const elapsed = now - startTimestamp;
  remainingMs = Math.max(gameTimeMs - elapsed, 0);

  updateTimerDisplay();

  if (remainingMs === 0) {
    stopTimer();
    return;
  }

  rafId = requestAnimationFrame(tick);
}

function startTimer() {
  if (timerRunning) return;

  timerRunning = true;
  startTimestamp = Date.now() + (gameTimeMs - remainingMs);
  tick();
}

function stopTimer() {
  timerRunning = false;
  cancelAnimationFrame(rafId);
}

function toggleTimer() {
  timerRunning ? stopTimer() : startTimer();
}

/* ===== 画面遷移 ===== */
function startGame() {
  remainingMs = gameTimeMs;
  updateTimerDisplay();
  showScreen(fieldScreen);
  drawMap();
}

function openSettings() {
  stopTimer();
  showScreen(settingsScreen);
}

function backToMain() {
  stopTimer();
  remainingMs = 0;
  updateTimerDisplay();
  showScreen(mainScreen);
}

function openTimerSetting() {
  document.getElementById("gameMinutes").value = gameTimeMs / 60000;
  showScreen(timerSettingScreen);
}

function saveTimer() {
  const min = Number(document.getElementById("gameMinutes").value);
  gameTimeMs = min * 60000;
  remainingMs = gameTimeMs;
  updateTimerDisplay();
  showScreen(fieldScreen);
}

/* ===== マップ ===== */
function drawMap() {
  const canvas = document.getElementById("map");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#444";
  for (let i = 0; i <= 10; i++) {
    ctx.beginPath();
    ctx.moveTo(i * 30, 0);
    ctx.lineTo(i * 30, 300);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0, i * 30);
    ctx.lineTo(300, i * 30);
    ctx.stroke();
  }

  ctx.fillStyle = "lime";
  ctx.beginPath();
  ctx.arc(150, 150, 6, 0, Math.PI * 2);
  ctx.fill();
}

/* ===== 起動時 ===== */
remainingMs = 0;
updateTimerDisplay();
</script>