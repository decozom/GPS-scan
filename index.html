<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Field Timer</title>

<style>
  body {
    margin: 0;
    font-family: "JetBrains Mono", "Source Code Pro", monospace;
    background: #111;
    color: #eee;
    text-align: center;
  }

  .screen {
    display: none;
    padding: 10px;
  }

  .active {
    display: block;
  }

  h1 {
    margin: 10px 0;
  }

  .version {
    font-size: 14px;
    color: #aaa;
  }

  /* ===== タイマー表示 ===== */
  #timer {
    font-size: 48px;
    margin: 15px 0;
    font-variant-numeric: slashed-zero;
    width: 280px;
    margin-left: auto;
    margin-right: auto;
  }

  .red {
    color: #ff4444;
  }

  .blink {
    animation: blink 1s steps(1) infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  /* ===== 擬似マップ ===== */
  #map {
    width: 300px;
    height: 300px;
    margin: 10px auto;
    background: #222;
    border: 2px solid #555;
    position: relative;
  }

  .grid {
    position: absolute;
    width: 100%;
    height: 100%;
    background-size: 30px 30px;
    background-image:
      linear-gradient(to right, #333 1px, transparent 1px),
      linear-gradient(to bottom, #333 1px, transparent 1px);
  }

  .player {
    width: 10px;
    height: 10px;
    background: #4af;
    border-radius: 50%;
    position: absolute;
    top: 145px;
    left: 145px;
  }

  button {
    font-size: 16px;
    margin: 5px;
    padding: 8px 14px;
  }
</style>
</head>

<body>

<!-- ===== メイン画面 ===== -->
<div id="main" class="screen active">
  <h1>Field Map</h1>
  <div class="version">Version 0.1</div>
  <button onclick="openField()">START</button>
</div>

<!-- ===== フィールド画面 ===== -->
<div id="field" class="screen">
  <div id="timer">00:00</div>

  <div id="map">
    <div class="grid"></div>
    <div class="player"></div>
  </div>

  <button onclick="toggleStart()">START / STOP</button>
  <button onclick="resetTimer()">RESET</button>
  <button onclick="scan()">SCAN</button>
  <button onclick="openSettings()">SETTINGS</button>
</div>

<!-- ===== 設定画面 ===== -->
<div id="settings" class="screen">
  <h2>Settings</h2>
  <button onclick="openTimerSet()">タイマーセット</button><br>
  <button onclick="backToMain()">メイン画面に戻る</button>
</div>

<!-- ===== タイマー設定 ===== -->
<div id="timerSet" class="screen">
  <h2>Timer Set (min)</h2>
  <input id="minuteInput" type="number" min="0" value="0">
  <br><br>
  <button onclick="setTimer()">決定</button>
  <button onclick="openSettings()">戻る</button>
</div>

<script>
  let setTimeMs = 0;
  let remainingMs = 0;
  let running = false;
  let timerInterval = null;

  let startTimestamp = 0;
  let lastRemainingMs = 0;

  function show(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function openField() { show('field'); updateDisplay(); }
  function openSettings() { show('settings'); }
  function backToMain() { show('main'); }
  function openTimerSet() { show('timerSet'); }

  function setTimer() {
    const min = Number(document.getElementById('minuteInput').value);
    setTimeMs = min * 60 * 1000;
    remainingMs = setTimeMs;
    updateDisplay();
    show('field');
  }

  function toggleStart() {
    if (!running) {
      if (remainingMs <= 0) remainingMs = setTimeMs;

      running = true;
      startTimestamp = performance.now();
      lastRemainingMs = remainingMs;

      timerInterval = setInterval(() => {
        const now = performance.now();
        const elapsed = now - startTimestamp;
        remainingMs = Math.max(0, lastRemainingMs - elapsed);

        if (remainingMs === 0) stopTimer();
        updateDisplay();
      }, 50);
    } else {
      stopTimer();
    }
  }

  function stopTimer() {
    running = false;
    clearInterval(timerInterval);
  }

  function resetTimer() {
    stopTimer();
    remainingMs = setTimeMs;
    updateDisplay();
  }

  function scan() {
    alert("GPS Scan (仮)");
  }

  function updateDisplay() {
    const t = document.getElementById('timer');
    let ms = remainingMs;

    t.classList.remove('red', 'blink');

    if (ms <= 180000) t.classList.add('red');
    if (ms <= 30000) t.classList.add('blink');

    if (ms > 180000) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      t.textContent =
        String(m).padStart(2, '0') + ":" +
        String(s).padStart(2, '0');
    } else {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const cs = Math.floor((ms % 1000) / 10);
      t.textContent =
        String(m).padStart(2, '0') + ":" +
        String(s).padStart(2, '0') + ":" +
        String(cs).padStart(2, '0');
    }

    if (setTimeMs === 0 && !running) t.textContent = "00:00";
  }

  updateDisplay();
</script>

</body>
</html>